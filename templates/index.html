<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Shipping Optimization with UPS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script>
        let itemCount = 3;
        let storeCount = 3;

        function addItem() {
            const orderContainer = document.getElementById('order-items');
            const newOrderEntry = document.createElement('div');
            newOrderEntry.className = 'order-entry';
            newOrderEntry.innerHTML = `
                <label>Item: <input type="text" name="order_item${itemCount}_name" value="Item ${itemCount + 1}"></label>
                Quantity: <input type="number" name="order_item${itemCount}" step="any" value="0">
                Weight (lbs): <input type="number" name="order_item${itemCount}_weight" step="any" value="1.0">
                L (in): <input type="number" name="order_item${itemCount}_length" step="any" value="10">
                W (in): <input type="number" name="order_item${itemCount}_width" step="any" value="10">
                H (in): <input type="number" name="order_item${itemCount}_height" step="any" value="10">
                <span class="delete-btn" onclick="deleteItem(this)">Delete</span>
            `;
            orderContainer.appendChild(newOrderEntry);

            const storeRows = document.querySelectorAll('.store-row');
            storeRows.forEach(row => {
                const stockCell = row.cells[3];
                const storeNameInput = row.cells[0].querySelector('input');
                const storeName = storeNameInput.value || `store${storeCount}`;
                stockCell.innerHTML += `
                    <div class="item-pair">
                        <input type="text" name="stock_${storeName}_item${itemCount}_name" value="Item ${itemCount + 1}">
                        <input type="number" name="stock_${storeName}_item${itemCount}" step="any" value="0">
                    </div>
                `;
            });
            itemCount++;
        }

        function deleteItem(button) {
            const entry = button.closest('.order-entry');
            entry.remove();
        }

        function addStore() {
            const tableBody = document.getElementById('store-table-body');
            const newRow = document.createElement('tr');
            newRow.className = 'store-row';
            newRow.innerHTML = `
                <td><input type="text" name="store${storeCount}_name" value="New Store ${storeCount + 1}" oninput="updateStoreReferences(this)"></td>
                <td><input type="text" name="origin_store${storeCount}" value="New City"></td>
                <td><input type="text" name="origin_postal_store${storeCount}" value="00000"></td>
                <td><input type="number" name="fixed_store${storeCount}" step="any" value="0"></td>
                <td>
                    ${Array.from({ length: itemCount }, (_, i) => `
                        <div class="item-pair">
                            <input type="text" name="stock_store${storeCount}_item${i}_name" value="${i < 3 ? ['Laptop', 'Mouse', 'Keyboard'][i] : 'Item ' + (i + 1)}">
                            <input type="number" name="stock_store${storeCount}_item${i}" step="any" value="0">
                        </div>
                    `).join('')}
                </td>
                <td><span class="delete-btn" onclick="deleteStore(this)">Delete</span></td>
            `;
            tableBody.appendChild(newRow);
            storeCount++;
        }

        function deleteStore(button) {
            const row = button.closest('.store-row');
            row.remove();
        }

        function updateStoreReferences(storeInput) {
            const row = storeInput.closest('.store-row');
            const newStoreName = storeInput.value || `store${storeCount}`;
            const originInput = row.cells[1].querySelector('input');
            const postalInput = row.cells[2].querySelector('input');
            const fixedInput = row.cells[3].querySelector('input');
            const stockCell = row.cells[4];
            const stockInputs = stockCell.querySelectorAll('input[type="number"]');

            originInput.name = `origin_${newStoreName}`;
            postalInput.name = `origin_postal_${newStoreName}`;
            fixedInput.name = `fixed_${newStoreName}`;
            stockInputs.forEach((input, i) => {
                input.name = `stock_${newStoreName}_item${i}`;
            });
        }

        function calculateShipping() {
            console.log("Calculate button clicked");
            const form = document.querySelector('form');
            const formData = new FormData(form);
            fetch('/calculate', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    console.log("Response received:", response.status);
                    return response.json();
                })
                .then(data => {
                    console.log("Data received:", data);
                    const resultDiv = document.getElementById('result');
                    if (data.error) {
                        resultDiv.innerHTML = `<p class="error">${data.error}</p>`;
                    } else {
                        let html = `
                        <h2>Results</h2>
                        <p>Total Shipping Cost: $${data.total_cost.toFixed(2)}</p>
                        <h3>Shipping Plan:</h3>
                    `;
                        for (const [store, items] of Object.entries(data.plan)) {
                            html += `<p><strong>Ship from ${store}:</strong></p><ul>`;
                            for (const [item, qty] of Object.entries(items)) {
                                html += `<li>${item}: ${qty}</li>`;
                            }
                            html += `</ul>`;
                        }
                        html += `<div class="breakdown"><h3>Cost Breakdown:</h3>`;
                        for (const [store, costs] of Object.entries(data.breakdown)) {
                            html += `
                            <p><strong>${store}:</strong></p>
                            <ul>
                                <li>Shipping Cost (UPS): $${costs.shipping_cost.toFixed(2)}</li>
                                <li>Fixed Cost: $${costs.fixed_cost.toFixed(2)}</li>
                                <li>Total: $${(costs.shipping_cost + costs.fixed_cost).toFixed(2)}</li>
                            </ul>
                        `;
                        }
                        html += `</div>`;
                        resultDiv.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    document.getElementById('result').innerHTML = `<p class="error">Error: ${error.message}</p>`;
                });
        }
    </script>
</head>

<body>
    <h1>Shipping Optimization with UPS</h1>
    <form>
        <div class="section">
            <h2>Order Details</h2>
            <div style="margin-bottom: 15px;">
                <label>Destination City: <input type="text" name="destination_city"
                        value="{{ sample_data.destination_city }}"></label>
                <label style="margin-left: 15px;">ZIP: <input type="text" name="destination_postal"
                        value="{{ sample_data.destination_postal }}"></label>
            </div>
            <div id="order-items">
                {% for i in range(3) %}
                {% set item = ['Laptop', 'Mouse', 'Keyboard'][i] %}
                <div class="order-entry">
                    <label>Item: <input type="text" name="order_item{{ i }}_name" value="{{ item }}"></label>
                    Quantity: <input type="number" name="order_item{{ i }}" step="any"
                        value="{{ sample_data.order_quantities.get(item, 0) }}">
                    Weight (lbs): <input type="number" name="order_item{{ i }}_weight" step="any"
                        value="{{ sample_data.item_weights.get(item, 1.0) }}">
                    L (in): <input type="number" name="order_item{{ i }}_length" step="any"
                        value="{{ sample_data.item_dimensions.get(item, {}).get('length', 10) }}">
                    W (in): <input type="number" name="order_item{{ i }}_width" step="any"
                        value="{{ sample_data.item_dimensions.get(item, {}).get('width', 10) }}">
                    H (in): <input type="number" name="order_item{{ i }}_height" step="any"
                        value="{{ sample_data.item_dimensions.get(item, {}).get('height', 10) }}">
                    <span class="delete-btn" onclick="deleteItem(this)">Delete</span>
                </div>
                {% endfor %}
            </div>
            <button type="button" onclick="addItem()">Add Item</button>
            <p style="font-size: 14px; color: #7f8c8d;">Sample data pre-filled. Costs are fetched from UPS API based on
                cities, weights, and dimensions.</p>
        </div>

        <div class="section">
            <h2>Store Details</h2>
            <table>
                <thead>
                    <tr>
                        <th>Store Name</th>
                        <th>Origin City</th>
                        <th>Origin ZIP</th>
                        <th>Fixed Cost</th>
                        <th>Stock (Item:Qty)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="store-table-body">
                    {% for store in stores %}
                    <tr class="store-row">
                        <td><input type="text" name="store{{ loop.index0 }}_name" value="{{ store }}"
                                oninput="updateStoreReferences(this)"></td>
                        <td><input type="text" name="origin_{{ store }}"
                                value="{{ sample_data.origin_cities.get(store, '') }}"></td>
                        <td><input type="text" name="origin_postal_{{ store }}"
                                value="{{ sample_data.origin_postals.get(store, '') }}"></td>
                        <td><input type="number" name="fixed_{{ store }}" step="any"
                                value="{{ sample_data.fixed_shipping_costs.get(store, 0) }}"></td>
                        <td>
                            {% for i in range(3) %}
                            {% set item = ['Laptop', 'Mouse', 'Keyboard'][i] %}
                            <div class="item-pair">
                                <input type="text" name="stock_{{ store }}_item{{ i }}_name" value="{{ item }}">
                                <input type="number" name="stock_{{ store }}_item{{ i }}" step="any"
                                    value="{{ sample_data.store_inventories.get(store, {}).get(item, 0) }}">
                            </div>
                            {% endfor %}
                        </td>
                        <td><span class="delete-btn" onclick="deleteStore(this)">Delete</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="button" onclick="addStore()">Add Store</button>
        </div>

        <button type="button" onclick="calculateShipping()">Calculate</button>
    </form>

    <div id="result"></div>
</body>

</html>